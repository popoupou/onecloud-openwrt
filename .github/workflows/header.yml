name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/popoupou/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  GEN_BURN_IMG_SH: gen_burn_img.sh
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  # Êñ∞Â¢ûÔºöÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖÂâçÁºÄÔºàÈÄÇÈÖçonecloudÁöÑmesonÊû∂ÊûÑÔºåÂèØÊ†πÊçÆÂÆûÈôÖË∞ÉÊï¥Ôºâ
  KERNEL_HEADERS_PREFIX: linux-headers

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: ÈáäÊîæÁ£ÅÁõòÁ©∫Èó¥
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Checkout
      uses: actions/checkout@main

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo sed -i 's/azure\.//' /etc/apt/sources.list
        sudo -E apt-get -qq update
        # Êñ∞Â¢ûÔºöË°•ÂÖÖÁºñËØëÂÜÖÊ†∏Â§¥Êñá‰ª∂ÊâÄÈúÄÁöÑ‰æùËµñ
        sudo -E apt-get -qq install $(cat dependson) libelf-dev dwarves bc bison flex
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        # Ê†∏ÂøÉ‰øÆÊîπ1ÔºöÂº∫Âà∂ÂêØÁî®ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÁºñËØëÔºàÂÖ≥ÈîÆÔºÅÔºâ
        # Âêë.config‰∏≠Ê∑ªÂä†ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÁºñËØëÈÖçÁΩÆÔºåË¶ÜÁõñÈªòËÆ§ÂÄº
        echo "CONFIG_PACKAGE_${{ env.KERNEL_HEADERS_PREFIX }}=y" >> .config
        # Á°Æ‰øùÂÜÖÊ†∏Ê®°ÂùóÁºñËØë‰æùËµñÂèØÁî®
        echo "CONFIG_KERNEL_BUILD_USER=\"github-actions\"" >> .config
        echo "CONFIG_KERNEL_BUILD_DOMAIN=\"github.com\"" >> .config
        # ÈáçÊñ∞ÁîüÊàêÈÖçÁΩÆÔºåÁ°Æ‰øùÈÄâÈ°πÁîüÊïà
        make defconfig

    - name: Download package
      id: package
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile the firmware
      id: compile
      run: |
        set -e
        cd openwrt
        echo -e "$(nproc) thread compile"
        echo "status=failed" >> $GITHUB_OUTPUT
        # ÁºñËØëÂõ∫‰ª∂+ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÔºàÂ¶ÇÊûú‰∏ªÁºñËØëÂ§±Ë¥•ÔºåÈôçÁ∫ßÂçïÁ∫øÁ®ãÔºâ
        if ! ( make -j$(nproc) || make -j1 || make -j1 V=s ); then
            echo "‚ùå Make failed"
            exit 1
        fi
        # Ê†∏ÂøÉ‰øÆÊîπ2ÔºöÂçïÁã¨ÁºñËØëÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖÔºàÁ°Æ‰øùÁîüÊàêÔºåÂÖúÂ∫ïÔºâ
        make package/linux/headers/compile V=s
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: ÁîüÊàêÁõ¥Âà∑ÂåÖ
      if: steps.compile.outputs.status == 'success'
      run: |
        chmod +x $GEN_BURN_IMG_SH
        chmod +x AmlImg
        $GITHUB_WORKSPACE/$GEN_BURN_IMG_SH

    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        # Ê†∏ÂøÉ‰øÆÊîπ3Ôºö‰øùÁïôÂÜÖÊ†∏Â§¥Êñá‰ª∂Áõ∏ÂÖ≥ÂåÖÔºåÂè™Âà†Èô§Êó†Áî®Êñá‰ª∂
        # ÂéüËÑöÊú¨‰ºöÂà†Èô§packagesÁõÆÂΩïÔºåÁé∞Âú®Ë∞ÉÊï¥ÔºöÂè™Âà†Èô§packages‰∏≠ÈùûÂÜÖÊ†∏Â§¥Êñá‰ª∂ÁöÑÂåÖÔºå‰øùÁïôÂÜÖÊ†∏Â§¥Êñá‰ª∂ipk
        if [ -d "packages" ]; then
          # Â§çÂà∂ÂÜÖÊ†∏Â§¥Êñá‰ª∂ipkÂà∞Âõ∫‰ª∂Ê†πÁõÆÂΩïÔºåÊñπ‰æøÊü•Êâæ
          cp packages/${{ env.KERNEL_HEADERS_PREFIX }}*.ipk ./ || true
          # Âà†Èô§packagesÁõÆÂΩïÔºàÂèØÈÄâÔºåÂ∑≤Â§çÂà∂Ê†∏ÂøÉÊñá‰ª∂Ôºâ
          rm -rf packages
        fi
        # Âè™Âà†Èô§Êó†Áî®ÁöÑÂÖÉÊñá‰ª∂Ôºå‰øùÁïôÂõ∫‰ª∂ÂíåÂÜÖÊ†∏Â§¥Êñá‰ª∂
        rm -rf feeds.buildinfo version.buildinfo sha256sums profiles.json *.sha *.manifest
        # È™åËØÅÂÜÖÊ†∏Â§¥Êñá‰ª∂ÊòØÂê¶ÁîüÊàê
        if ls ${{ env.KERNEL_HEADERS_PREFIX }}*.ipk 1> /dev/null 2>&1; then
          echo "‚úÖ ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖÂ∑≤ÁîüÊàêÔºö$(ls ${{ env.KERNEL_HEADERS_PREFIX }}*.ipk)"
        else
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖÔºåÂèØËÉΩÁºñËØëÂ§±Ë¥•"
        fi
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: |
          ${{ env.FIRMWARE }}/*
          # ÊòæÂºèÂåÖÂê´ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÔºàÂÖúÂ∫ïÔºâ
          openwrt/bin/packages/*/*/${{ env.KERNEL_HEADERS_PREFIX }}*.ipk

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        # Êñ∞Â¢ûÔºöÂú®releaseËØ¥Êòé‰∏≠Ê†áÊ≥®ÂÜÖÊ†∏Â§¥Êñá‰ª∂‰ø°ÊÅØ
        echo "## ÁºñËØë‰∫ßÁâ©ËØ¥Êòé" >> release.txt
        echo "- OpenWRTÂõ∫‰ª∂ÔºàÈÄÇÈÖçonecloudÔºâ" >> release.txt
        echo "- ÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖÔºàÁî®‰∫éÁºñËØëÁΩëÂç°È©±Âä®Ôºâ" >> release.txt
        [ ${UPLOAD_GOFILE} = true && ${{ steps.gofile.outputs.url }} ] && echo "üîó [GoFile](${{ steps.gofile.outputs.url }})" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v2.1.0
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: |
          ${{ env.FIRMWARE }}/*
          # Á°Æ‰øùÂÜÖÊ†∏Â§¥Êñá‰ª∂ÂåÖ‰∏ä‰º†Âà∞Release
          openwrt/bin/packages/*/*/${{ env.KERNEL_HEADERS_PREFIX }}*.ipk

    - name: Delete workflow runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
